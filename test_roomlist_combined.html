<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Combined Roomlist Export</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>Test Combined Roomlist Export</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>Test Combined Roomlist Export</h5>
                            <p>This test verifies that the roomlist export now creates a single combined sheet with both Medinah and Makkah rooms.</p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="pakId" class="form-label">Package ID to Test:</label>
                            <input type="number" class="form-control" id="pakId" value="12" placeholder="Enter package ID">
                        </div>
                        
                        <button id="testRoomlistExport" class="btn btn-primary">Test Combined Roomlist Export</button>
                        
                        <div id="results" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('#testRoomlistExport').on('click', function() {
            const pakId = $('#pakId').val();
            
            if (!pakId) {
                alert('Please enter a package ID');
                return;
            }
            
            const resultsDiv = $('#results');
            resultsDiv.html('<div class="alert alert-info">Testing roomlist export...</div>');
            
            // Fetch roomlist data via AJAX
            $.ajax({
                url: 'export_manifest.php',
                type: 'POST',
                data: { pak_id: pakId, export_type: 'roomlist' },
                success: function(response) {
                    console.log('Roomlist export response:', response);
                    
                    if (!response.success) {
                        resultsDiv.html(`<div class="alert alert-danger">Error: ${response.message || 'Failed to export roomlist'}</div>`);
                        return;
                    }
                    
                    if (!response.data || !response.data.roomLists) {
                        resultsDiv.html('<div class="alert alert-warning">No roomlist data found</div>');
                        return;
                    }
                    
                    const data = response.data;
                    
                    // Verify the structure
                    let medinahCount = data.roomLists.medinah ? data.roomLists.medinah.length : 0;
                    let makkahCount = data.roomLists.makkah ? data.roomLists.makkah.length : 0;
                    
                    // Create workbook for roomlist export
                    const wb = XLSX.utils.book_new();
                    
                    // Create combined roomlist sheet (Medinah and Makkah together)
                    if ((data.roomLists.medinah && data.roomLists.medinah.length > 0) || 
                        (data.roomLists.makkah && data.roomLists.makkah.length > 0)) {
                        
                        const roomlistHeaderInfo = [
                            [`Roomlist - ${data.package.name || 'Unknown Package'}`],
                            [`Tanggal ${data.package.departure_date || 'Unknown Date'}`],
                            [`Program ${data.package.type || 'Unknown Type'}`],
                            [''],
                            ['Location', 'Room Number', 'Type', 'Guest', 'Name', 'NIK', 'Sex', 'Age', 'Relation']
                        ];
                        
                        // Combine both Medinah and Makkah data
                        const combinedRoomlistRows = [];
                        
                        // Add Medinah rooms first
                        if (data.roomLists.medinah && data.roomLists.medinah.length > 0) {
                            data.roomLists.medinah.forEach(row => {
                                combinedRoomlistRows.push([
                                    'Medinah',
                                    row['Room Number'] || '',
                                    row['Type'] || '',
                                    row['Guest'] || '',
                                    row['Name'] || '',
                                    row['NIK'] || '',
                                    row['Sex'] || '',
                                    row['Age'] || '',
                                    row['Relation'] || ''
                                ]);
                            });
                        }
                        
                        // Add separator row if both locations have data
                        if (data.roomLists.medinah?.length > 0 && data.roomLists.makkah?.length > 0) {
                            combinedRoomlistRows.push(['', '', '', '', '', '', '', '', '']);
                        }
                        
                        // Add Makkah rooms
                        if (data.roomLists.makkah && data.roomLists.makkah.length > 0) {
                            data.roomLists.makkah.forEach(row => {
                                combinedRoomlistRows.push([
                                    'Makkah',
                                    row['Room Number'] || '',
                                    row['Type'] || '',
                                    row['Guest'] || '',
                                    row['Name'] || '',
                                    row['NIK'] || '',
                                    row['Sex'] || '',
                                    row['Age'] || '',
                                    row['Relation'] || ''
                                ]);
                            });
                        }
                        
                        const roomlistData = [...roomlistHeaderInfo, ...combinedRoomlistRows];
                        const wsRoomlist = XLSX.utils.aoa_to_sheet(roomlistData);
                        
                        XLSX.utils.book_append_sheet(wb, wsRoomlist, 'Roomlist');
                        
                        // Create filename for roomlist
                        let packageName = (data.package.name || 'test_package').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        const filename = `test_combined_roomlist_${packageName}_pak${pakId}.xlsx`;
                        
                        // Export the workbook to file
                        XLSX.writeFile(wb, filename);
                        
                        resultsDiv.html(`
                            <div class="alert alert-success">
                                <h5>âœ… Combined Roomlist Export Test Successful!</h5>
                                <p><strong>File:</strong> ${filename}</p>
                                <p><strong>Package:</strong> ${data.package.name}</p>
                                <p><strong>Total rows:</strong> ${combinedRoomlistRows.length}</p>
                                <p><strong>Medinah rooms:</strong> ${medinahCount}</p>
                                <p><strong>Makkah rooms:</strong> ${makkahCount}</p>
                                <p><strong>Structure:</strong> Single combined sheet with "Location" column</p>
                                <p class="mb-0"><em>The Excel file has been downloaded to your Downloads folder.</em></p>
                            </div>
                        `);
                        
                    } else {
                        resultsDiv.html('<div class="alert alert-warning">No room data found for this package</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Roomlist export error:', error);
                    let message = 'Error testing roomlist export';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        message = response.message || message;
                    } catch (e) {}
                    resultsDiv.html(`<div class="alert alert-danger">Error: ${message}</div>`);
                }
            });
        });
    </script>
</body>
</html>
